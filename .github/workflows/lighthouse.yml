name: Lighthouse CI

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      commit_id:
        description: "ì»¤ë°‹ ID (SHA) - í•´ë‹¹ ì»¤ë°‹ ê¸°ì¤€ìœ¼ë¡œ ë¹Œë“œ ë° ì„±ëŠ¥ ê²€ì‚¬ (ë¹„ì›Œë‘ë©´ ìµœì‹  ì»¤ë°‹ ì‚¬ìš©)"
        required: false
        default: ""
      url:
        description: "URL to run Lighthouse on (leave empty to use GitHub Pages URL)"
        required: false
        default: ""
      commit_message:
        description: "ì»¤ë°‹ ë©”ì‹œì§€ (Issue ì œëª©ì— ì‚¬ìš©ë©ë‹ˆë‹¤, ë¹„ì›Œë‘ë©´ ì„ íƒí•œ ì»¤ë°‹ì˜ ë©”ì‹œì§€ ì‚¬ìš©)"
        required: false
        default: ""

permissions:
  issues: write
  contents: write
  pages: write
  id-token: write

jobs:
  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    # ì»¤ë°‹ ë©”ì‹œì§€ì— 'perf'ê°€ í¬í•¨ëœ ê²½ìš°ì—ë§Œ ì‹¤í–‰
    if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, 'perf')
    # environmentë¥¼ ì œê±°í•˜ì—¬ ë³´í˜¸ ê·œì¹™ ìš°íšŒ (GitHub ì„¤ì •ì—ì„œ í™˜ê²½ ë³´í˜¸ ê·œì¹™ ìˆ˜ì •í•˜ëŠ” ê²ƒì„ ê¶Œì¥)
    # environment:
    #   name: github-pages
    #   url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ì „ì²´ íˆìŠ¤í† ë¦¬ë¥¼ ê°€ì ¸ì™€ì„œ diffë¥¼ ìœ„í•´ í•„ìš”

      - name: Checkout specific commit
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.commit_id != ''
        run: |
          COMMIT_ID="${{ github.event.inputs.commit_id }}"
          echo "Input commit ID: $COMMIT_ID"

          # ì§§ì€ SHAë¥¼ ì „ì²´ SHAë¡œ ë³€í™˜ (git rev-parseëŠ” ì§§ì€ SHAë„ ì§€ì›)
          FULL_COMMIT_ID=$(git rev-parse "$COMMIT_ID" 2>/dev/null || echo "")
          if [ -z "$FULL_COMMIT_ID" ]; then
            echo "âŒ Error: Commit '$COMMIT_ID' not found in repository"
            exit 1
          fi

          echo "Full commit ID: $FULL_COMMIT_ID"
          echo "Checking out commit: $FULL_COMMIT_ID"
          git checkout $FULL_COMMIT_ID
          echo "Current commit: $(git rev-parse HEAD)"
          echo "Commit message: $(git log -1 --pretty=%B)"

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies & build app
        run: |
          npm install -g pnpm gh-pages
          pnpm install --frozen-lockfile
          pnpm run build

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Deploy to gh-pages branch
        id: deployment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # gh-pages ë¸Œëœì¹˜ì— dist í´ë” ë°°í¬
          npx gh-pages -d dist \
            -u "github-actions[bot] <github-actions[bot]@users.noreply.github.com>" \
            --message "Deploy from commit ${{ github.event.inputs.commit_id || github.sha }}" \
            --repo "https://${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
          echo "Deployed to gh-pages branch"
          # GitHub Pages URL êµ¬ì„±
          REPO_NAME="${{ github.event.repository.name }}"
          GITHUB_PAGES_URL="https://${{ github.repository_owner }}.github.io/${REPO_NAME}/"
          echo "page_url=$GITHUB_PAGES_URL" >> $GITHUB_OUTPUT

  restore-latest:
    name: Restore Latest Commit (if needed)
    runs-on: ubuntu-latest
    needs: lighthouse-audit
    # workflow_dispatchì—ì„œ ê³¼ê±° ì»¤ë°‹ìœ¼ë¡œ ë°°í¬í•œ ê²½ìš°ì—ë§Œ ìµœì‹  ì»¤ë°‹ìœ¼ë¡œ ë³µêµ¬
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.commit_id != ''
    # environmentë¥¼ ì œê±°í•˜ì—¬ ë³´í˜¸ ê·œì¹™ ìš°íšŒ (GitHub ì„¤ì •ì—ì„œ í™˜ê²½ ë³´í˜¸ ê·œì¹™ ìˆ˜ì •í•˜ëŠ” ê²ƒì„ ê¶Œì¥)
    # environment:
    #   name: github-pages
    #   url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies & build app
        run: |
          npm install -g pnpm gh-pages
          pnpm install --frozen-lockfile
          pnpm run build

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Deploy to gh-pages branch (restore latest)
        id: deployment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # gh-pages ë¸Œëœì¹˜ì— dist í´ë” ë°°í¬ (ìµœì‹  ì»¤ë°‹ ê¸°ì¤€)
          npx gh-pages -d dist \
            -u "github-actions[bot] <github-actions[bot]@users.noreply.github.com>" \
            --message "Restore to latest commit ${{ github.sha }}" \
            --repo "https://${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
          echo "Restored to latest commit on gh-pages branch"
          # GitHub Pages URL êµ¬ì„±
          REPO_NAME="${{ github.event.repository.name }}"
          GITHUB_PAGES_URL="https://${{ github.repository_owner }}.github.io/${REPO_NAME}/"
          echo "page_url=$GITHUB_PAGES_URL" >> $GITHUB_OUTPUT

  lighthouse-audit:
    name: Lighthouse Audit
    runs-on: ubuntu-latest
    needs: deploy
    # ì»¤ë°‹ ë©”ì‹œì§€ì— 'perf'ê°€ í¬í•¨ëœ ê²½ìš°ì—ë§Œ ì‹¤í–‰
    if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, 'perf')
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ì „ì²´ íˆìŠ¤í† ë¦¬ë¥¼ ê°€ì ¸ì™€ì„œ diffë¥¼ ìœ„í•´ í•„ìš”

      - name: Checkout specific commit
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.commit_id != ''
        run: |
          COMMIT_ID="${{ github.event.inputs.commit_id }}"
          echo "Input commit ID: $COMMIT_ID"

          # ì§§ì€ SHAë¥¼ ì „ì²´ SHAë¡œ ë³€í™˜ (git rev-parseëŠ” ì§§ì€ SHAë„ ì§€ì›)
          FULL_COMMIT_ID=$(git rev-parse "$COMMIT_ID" 2>/dev/null || echo "")
          if [ -z "$FULL_COMMIT_ID" ]; then
            echo "âŒ Error: Commit '$COMMIT_ID' not found in repository"
            exit 1
          fi

          echo "Full commit ID: $FULL_COMMIT_ID"
          echo "Checking out commit: $FULL_COMMIT_ID"
          git checkout $FULL_COMMIT_ID
          echo "Current commit: $(git rev-parse HEAD)"
          echo "Commit message: $(git log -1 --pretty=%B)"

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Lighthouse CI
        run: |
          npm install -g @lhci/cli@0.14.x pnpm

      - name: Wait for deployment
        run: |
          echo "Waiting for GitHub Pages deployment to be ready..."
          sleep 30
          echo "Deployment should be ready now"

      - name: Run Lighthouse CI
        id: lighthouse
        continue-on-error: true
        run: |
          # GitHub Pages URL êµ¬ì„±
          # github.repository í˜•ì‹: owner/repo-name
          REPO_NAME="${{ github.event.repository.name }}"
          GITHUB_PAGES_URL="https://${{ github.repository_owner }}.github.io/${REPO_NAME}/"

          # workflow_dispatchì—ì„œ URLì´ ì…ë ¥ëœ ê²½ìš° í•´ë‹¹ URL ì‚¬ìš©, ì•„ë‹ˆë©´ GitHub Pages URL ì‚¬ìš©
          if [ -n "${{ github.event.inputs.url }}" ]; then
            URL="${{ github.event.inputs.url }}"
          else
            URL="$GITHUB_PAGES_URL"
          fi

          echo "Target URL: $URL"
          echo "Running Lighthouse CI on: $URL"

          # URL ì ‘ê·¼ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
          for i in {1..10}; do
            if curl -f -s "$URL" > /dev/null; then
              echo "âœ… URL is accessible: $URL"
              break
            else
              echo "â³ Waiting for deployment... ($i/10)"
              sleep 10
            fi
          done

          # Lighthouse CI ì„¤ì • íŒŒì¼ ìƒì„±
          cat > lighthouserc.json << EOF
          {
            "ci": {
              "collect": {
                "url": ["$URL"],
                "numberOfRuns": 1,
                "settings": {
                  "skipAudits": []
                }
              },
              "upload": {
                "target": "filesystem",
                "outputDir": ".lighthouseci"
              }
            }
          }
          EOF

          # Lighthouse CI ì‹¤í–‰
          lhci autorun || {
            echo "Lighthouse CI failed, trying alternative method..."
            npx @lhci/cli@0.14.x autorun || echo "All Lighthouse methods failed"
          }

          echo "Lighthouse CI execution completed"

      - name: Check Lighthouse reports
        if: always()
        run: |
          if [ -d ".lighthouseci" ]; then
            echo "Lighthouse reports directory exists"
            ls -la .lighthouseci/ || echo "Directory is empty"
          else
            echo "Lighthouse reports directory does not exist"
          fi

      - name: Get changed files diff
        id: get_diff
        if: always()
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            # push ì´ë²¤íŠ¸: ì´ì „ ì»¤ë°‹ê³¼ í˜„ì¬ ì»¤ë°‹ ê°„ì˜ diff
            if [ -n "${{ github.event.before }}" ] && [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
              git diff ${{ github.event.before }}..${{ github.sha }} > /tmp/changes.diff || echo "No changes" > /tmp/changes.diff
            else
              echo "Initial commit or no previous commit" > /tmp/changes.diff
            fi
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.commit_id }}" ]; then
            # workflow_dispatch + commit_id ì…ë ¥: í•´ë‹¹ ì»¤ë°‹ê³¼ ì´ì „ ì»¤ë°‹ ê°„ì˜ diff
            COMMIT_ID="${{ github.event.inputs.commit_id }}"
            # ì§§ì€ SHAë¥¼ ì „ì²´ SHAë¡œ ë³€í™˜
            FULL_COMMIT_ID=$(git rev-parse "$COMMIT_ID" 2>/dev/null || echo "")
            if [ -z "$FULL_COMMIT_ID" ]; then
              echo "Error: Commit '$COMMIT_ID' not found" > /tmp/changes.diff
            else
              PARENT_COMMIT=$(git rev-parse ${FULL_COMMIT_ID}^ 2>/dev/null || echo "")
              if [ -n "$PARENT_COMMIT" ]; then
                git diff ${PARENT_COMMIT}..${FULL_COMMIT_ID} > /tmp/changes.diff || echo "No changes" > /tmp/changes.diff
              else
                echo "Initial commit or no parent commit" > /tmp/changes.diff
              fi
            fi
          else
            # workflow_dispatch without commit_id: diff ì—†ìŒ
            echo "No diff available" > /tmp/changes.diff
          fi

      - name: Create GitHub Issue with Results
        if: always()
        uses: actions/github-script@v6
        with:
          github-token: ${{ github.token }}
          script: |
            const fs = require('fs');
            const path = require('path');
            const { execSync } = require('child_process');

            // ì»¤ë°‹ ë©”ì‹œì§€ì—ì„œ ì œëª© ì¶”ì¶œ
            let commitMessage;
            if (context.eventName === 'push') {
              commitMessage = context.payload.head_commit?.message || 'No commit message';
            } else if (context.eventName === 'workflow_dispatch') {
              const commitId = context.payload.inputs?.commit_id;
              const inputCommitMessage = context.payload.inputs?.commit_message;
              
              if (commitId && !inputCommitMessage) {
                // commit_idê°€ ìˆê³  ì»¤ë°‹ ë©”ì‹œì§€ê°€ ì…ë ¥ë˜ì§€ ì•Šì•˜ìœ¼ë©´ í•´ë‹¹ ì»¤ë°‹ì˜ ë©”ì‹œì§€ ì‚¬ìš©
                try {
                  const { execSync } = require('child_process');
                  // ì§§ì€ SHAë¥¼ ì „ì²´ SHAë¡œ ë³€í™˜ (git rev-parseëŠ” ì§§ì€ SHAë„ ì§€ì›)
                  const fullCommitId = execSync(`git rev-parse ${commitId}`, { encoding: 'utf8' }).trim();
                  commitMessage = execSync(`git log -1 --pretty=%B ${fullCommitId}`, { encoding: 'utf8' }).trim();
                } catch (e) {
                  commitMessage = `Commit ${commitId.substring(0, 7)}`;
                }
              } else if (inputCommitMessage) {
                // ì»¤ë°‹ ë©”ì‹œì§€ê°€ ì…ë ¥ë˜ì—ˆìœ¼ë©´ ì‚¬ìš©
                commitMessage = inputCommitMessage;
              } else {
                commitMessage = 'Manual workflow run';
              }
            } else {
              commitMessage = 'Manual workflow run';
            }
            const commitTitle = commitMessage.split('\n')[0].trim();

            // ë³€ê²½ëœ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            let codeChanges = '';
            try {
              const diffPath = '/tmp/changes.diff';
              if (fs.existsSync(diffPath)) {
                const diffContent = fs.readFileSync(diffPath, 'utf8');
                if (diffContent && 
                    !diffContent.includes('No changes') && 
                    !diffContent.includes('Initial commit') && 
                    !diffContent.includes('No diff available') &&
                    !diffContent.includes('no parent commit')) {
                  // diffê°€ ë„ˆë¬´ ê¸¸ë©´ ì˜ë¼ë‚´ê¸° (GitHub IssueëŠ” 65,536ì ì œí•œ)
                  const maxLength = 50000;
                  let formattedDiff = diffContent;
                  if (diffContent.length > maxLength) {
                    formattedDiff = diffContent.substring(0, maxLength) + '\n\n... (truncated due to length)';
                  }
                  // diffë¥¼ ì½”ë“œ ë¸”ë¡ìœ¼ë¡œ í¬ë§·íŒ…
                  codeChanges = `\n### ğŸ“ ë³€ê²½ëœ ì½”ë“œ\n\n\`\`\`diff\n${formattedDiff}\n\`\`\`\n`;
                }
              }
            } catch (e) {
              console.log('Could not read diff:', e.message);
            }

            const lhciDir = '.lighthouseci';

            // Lighthouse ë¦¬í¬íŠ¸ ë””ë ‰í† ë¦¬ ë° íŒŒì¼ í™•ì¸
            console.log('Checking for Lighthouse reports...');
            console.log('Current working directory:', process.cwd());
            console.log('Lighthouse directory exists:', fs.existsSync(lhciDir));

            if (!fs.existsSync(lhciDir)) {
              console.log('âŒ Lighthouse ë¦¬í¬íŠ¸ ë””ë ‰í† ë¦¬ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
              console.log('Lighthouse CIê°€ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. Lighthouse CI ì‹¤í–‰ ë‹¨ê³„ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
              console.log('Issueë¥¼ ìƒì„±í•˜ì§€ ì•Šê³  ì¢…ë£Œí•©ë‹ˆë‹¤.');
              return;
            }

            const allFiles = fs.readdirSync(lhciDir);
            console.log('Files in .lighthouseci:', allFiles);

            // Lighthouse CIëŠ” ë³´í†µ -report.json í˜•ì‹ì˜ íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤
            const jsonReports = allFiles.filter(f => f.endsWith('.json') && f.includes('report'));
            // reportê°€ ì—†ëŠ” ê²½ìš° ëª¨ë“  json íŒŒì¼ ê²€ìƒ‰
            const allJsonReports = jsonReports.length > 0 ? jsonReports : allFiles.filter(f => f.endsWith('.json'));
            console.log('JSON reports found:', allJsonReports);

            if (allJsonReports.length === 0) {
              console.log('âŒ Lighthouse ë¦¬í¬íŠ¸ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
              console.log('Lighthouse CIê°€ ì‹¤í–‰ë˜ì—ˆì§€ë§Œ ë¦¬í¬íŠ¸ íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
              console.log('Available files:', allFiles);
              console.log('Issueë¥¼ ìƒì„±í•˜ì§€ ì•Šê³  ì¢…ë£Œí•©ë‹ˆë‹¤.');
              return;
            }

            // ê°€ì¥ ìµœì‹  ë¦¬í¬íŠ¸ ì°¾ê¸° (íŒŒì¼ëª… ê¸°ì¤€)
            const latestReport = allJsonReports.sort().reverse()[0];
            console.log('Latest report:', latestReport);

            if (!latestReport) {
              console.log('âŒ ìµœì‹  Lighthouse ë¦¬í¬íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              return;
            }

            const reportPath = path.join(lhciDir, latestReport);
            console.log('Reading report from:', reportPath);
            const reportContent = fs.readFileSync(reportPath, 'utf8');
            let report = JSON.parse(reportContent);
            console.log('Report loaded successfully');

            // ë¦¬í¬íŠ¸ê°€ ë°°ì—´ì¸ ê²½ìš° ì²« ë²ˆì§¸ í•­ëª© ì‚¬ìš©
            if (Array.isArray(report)) {
              console.log('Report is an array, using first item');
              report = report[0];
            }

            // ë¦¬í¬íŠ¸ êµ¬ì¡° ë””ë²„ê¹…
            console.log('Report keys:', Object.keys(report));
            console.log('Has categories:', !!report.categories);
            if (report.categories) {
              console.log('Category keys:', Object.keys(report.categories));
              console.log('Performance score:', report.categories.performance?.score);
            }
            if (report.audits) {
              console.log('Has audits:', true);
              console.log('LCP audit:', report.audits['largest-contentful-paint']?.numericValue);
            }

            const formatScore = (value) => {
              if (value === null || value === undefined) {
                return 'N/A';
              }
              return Math.round(value * 100);
            };

            const getEmoji = (value, metric) => {
              if (value === null || value === undefined) {
                return 'âšª'; // ë°ì´í„° ì—†ìŒ
              }
              
              const thresholds = {
                LCP: { good: 2500, needsImprovement: 4000 },
                INP: { good: 200, needsImprovement: 500 },
                CLS: { good: 0.1, needsImprovement: 0.25 },
              };
              
              // Web Vitals ë©”íŠ¸ë¦­ ì²˜ë¦¬
              if (thresholds[metric]) {
                const t = thresholds[metric];
                // LCP, INPëŠ” ë°€ë¦¬ì´ˆ ë‹¨ìœ„, CLSëŠ” ì†Œìˆ˜ì 
                if (metric === 'CLS') {
                  return value <= t.good ? 'ğŸŸ¢' : value <= t.needsImprovement ? 'ğŸŸ ' : 'ğŸ”´';
                } else {
                  // LCP, INPëŠ” ê°’ì´ ì‘ì„ìˆ˜ë¡ ì¢‹ìŒ
                  return value <= t.good ? 'ğŸŸ¢' : value <= t.needsImprovement ? 'ğŸŸ ' : 'ğŸ”´';
                }
              }
              
              // ì ìˆ˜ ê¸°ë°˜ (0-100)
              return value >= 90 ? 'ğŸŸ¢' : value >= 50 ? 'ğŸŸ ' : 'ğŸ”´';
            };

            const formatMetric = (value, metric) => {
              if (value === null || value === undefined) {
                return 'N/A';
              }
              if (metric === 'CLS') {
                return value.toFixed(3);
              }
              // LCP, INPëŠ” ë°€ë¦¬ì´ˆ ë‹¨ìœ„
              return `${(value / 1000).toFixed(2)}s`;
            };

            const getLighthouseResult = (report, category) => {
              try {
                // ë¦¬í¬íŠ¸ êµ¬ì¡° í™•ì¸
                if (!report || !report.categories) {
                  console.log(`Warning: Report or categories missing for ${category}`);
                  return null;
                }
                
                const categoryData = report.categories[category];
                if (!categoryData) {
                  console.log(`Warning: Category ${category} not found`);
                  return null;
                }
                
                const score = categoryData.score;
                if (score === null || score === undefined) {
                  console.log(`Warning: Score is null/undefined for ${category}`);
                  return null;
                }
                
                // scoreëŠ” 0-1 ì‚¬ì´ì˜ ê°’ì´ë¯€ë¡œ ê·¸ëŒ€ë¡œ ë°˜í™˜
                return score;
              } catch (e) {
                console.log(`Error getting result for ${category}:`, e.message);
                return null;
              }
            };

            const getMetricValue = (report, metric) => {
              try {
                if (!report || !report.audits) {
                  return null;
                }
                
                const audit = report.audits[metric];
                if (!audit) {
                  return null;
                }
                
                return audit.numericValue ?? null;
              } catch (e) {
                console.log(`Error getting metric ${metric}:`, e.message);
                return null;
              }
            };

            const lighthouseScores = {
              performance: getLighthouseResult(report, 'performance'),
              accessibility: getLighthouseResult(report, 'accessibility'),
              'best-practices': getLighthouseResult(report, 'best-practices'),
              seo: getLighthouseResult(report, 'seo'),
              pwa: getLighthouseResult(report, 'pwa')
            };

            const webVitals = {
              LCP: getMetricValue(report, 'largest-contentful-paint'),
              INP: getMetricValue(report, 'experimental-interaction-to-next-paint'),
              CLS: getMetricValue(report, 'cumulative-layout-shift')
            };

            const reportUrl = `.lighthouseci/${latestReport.replace('.json', '.html')}`;

            // ì‹œê°„ í¬ë§·íŒ…
            const now = new Date();
            const timeStr = now.toLocaleString('ko-KR', { 
              timeZone: 'Asia/Seoul',
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit',
              hour12: false
            });

            // ì»¤ë°‹ ì •ë³´ ì¶”ê°€
            const commitId = context.payload.inputs?.commit_id;
            let commitInfo = '';
            if (commitId) {
              try {
                // ì§§ì€ SHAë¥¼ ì „ì²´ SHAë¡œ ë³€í™˜
                const fullCommitId = execSync(`git rev-parse ${commitId}`, { encoding: 'utf8' }).trim();
                const shortCommitId = fullCommitId.substring(0, 7);
                const commitUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/commit/${fullCommitId}`;
                commitInfo = `\n### ğŸ“Œ ì¸¡ì • ê¸°ì¤€ ì»¤ë°‹\n- **ì»¤ë°‹ ID**: [\`${shortCommitId}\`](${commitUrl})\n- **ì»¤ë°‹ ë©”ì‹œì§€**: ${commitTitle}\n\n`;
              } catch (e) {
                // ë³€í™˜ ì‹¤íŒ¨ ì‹œ ì›ë³¸ ì‚¬ìš©
                const shortCommitId = commitId.substring(0, 7);
                const commitUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/commit/${commitId}`;
                commitInfo = `\n### ğŸ“Œ ì¸¡ì • ê¸°ì¤€ ì»¤ë°‹\n- **ì»¤ë°‹ ID**: [\`${shortCommitId}\`](${commitUrl})\n- **ì»¤ë°‹ ë©”ì‹œì§€**: ${commitTitle}\n\n`;
              }
            }

            const body = `## ğŸš¨ ì›¹ì‚¬ì´íŠ¸ ì„±ëŠ¥ ì¸¡ì • ê²°ê³¼

            ${commitInfo}${codeChanges}

            ### ğŸ¯ Lighthouse ì ìˆ˜
            | ì¹´í…Œê³ ë¦¬ | ì ìˆ˜ | ìƒíƒœ |
            |----------|------|------|
            | Performance | ${formatScore(lighthouseScores.performance)}${lighthouseScores.performance !== null ? '%' : ''} | ${getEmoji(lighthouseScores.performance !== null ? formatScore(lighthouseScores.performance) : null)} |
            | Accessibility | ${formatScore(lighthouseScores.accessibility)}${lighthouseScores.accessibility !== null ? '%' : ''} | ${getEmoji(lighthouseScores.accessibility !== null ? formatScore(lighthouseScores.accessibility) : null)} |
            | Best Practices | ${formatScore(lighthouseScores['best-practices'])}${lighthouseScores['best-practices'] !== null ? '%' : ''} | ${getEmoji(lighthouseScores['best-practices'] !== null ? formatScore(lighthouseScores['best-practices']) : null)} |
            | SEO | ${formatScore(lighthouseScores.seo)}${lighthouseScores.seo !== null ? '%' : ''} | ${getEmoji(lighthouseScores.seo !== null ? formatScore(lighthouseScores.seo) : null)} |
            | PWA | ${formatScore(lighthouseScores.pwa)}${lighthouseScores.pwa !== null ? '%' : ''} | ${getEmoji(lighthouseScores.pwa !== null ? formatScore(lighthouseScores.pwa) : null)} |

            ### ğŸ“Š Core Web Vitals (2024)
            | ë©”íŠ¸ë¦­ | ì„¤ëª… | ì¸¡ì •ê°’ | ìƒíƒœ |
            |--------|------|--------|------|
            | LCP | Largest Contentful Paint | ${formatMetric(webVitals.LCP, 'LCP')} | ${getEmoji(webVitals.LCP, 'LCP')} |
            | INP | Interaction to Next Paint | ${formatMetric(webVitals.INP, 'INP')} | ${getEmoji(webVitals.INP, 'INP')} |
            | CLS | Cumulative Layout Shift | ${formatMetric(webVitals.CLS, 'CLS')} | ${getEmoji(webVitals.CLS, 'CLS')} |

            ### ğŸ“ Core Web Vitals ê¸°ì¤€ê°’
            - **LCP (Largest Contentful Paint)**: ê°€ì¥ í° ì½˜í…ì¸ ê°€ í™”ë©´ì— ê·¸ë ¤ì§€ëŠ” ì‹œì  
              - ğŸŸ¢ Good: < 2.5s
              - ğŸŸ  Needs Improvement: < 4.0s
              - ğŸ”´ Poor: â‰¥ 4.0s

            - **INP (Interaction to Next Paint)**: ì‚¬ìš©ì ìƒí˜¸ì‘ìš©ì— ëŒ€í•œ ì „ë°˜ì ì¸ ì‘ë‹µì„±
              - ğŸŸ¢ Good: < 200ms
              - ğŸŸ  Needs Improvement: < 500ms
              - ğŸ”´ Poor: â‰¥ 500ms

            - **CLS (Cumulative Layout Shift)**: í˜ì´ì§€ ë¡œë“œ ì¤‘ ì˜ˆê¸°ì¹˜ ì•Šì€ ë ˆì´ì•„ì›ƒ ë³€ê²½ì˜ ì •ë„
              - ğŸŸ¢ Good: < 0.1
              - ğŸŸ  Needs Improvement: < 0.25
              - ğŸ”´ Poor: â‰¥ 0.25

            > ğŸ“… ì¸¡ì • ì‹œê°„: ${timeStr}`;

            // Issue ì œëª©: ì»¤ë°‹ ë©”ì‹œì§€ ì œëª© + ì‹œê°„
            // workflow_dispatchì—ì„œ ì»¤ë°‹ ë©”ì‹œì§€ê°€ ì…ë ¥ë˜ì—ˆê±°ë‚˜ commit_idê°€ ìˆëŠ” ê²½ìš° ì‚¬ìš©
            const commitId = context.payload.inputs?.commit_id;
            let issueTitle;
            if (context.eventName === 'push') {
              issueTitle = `ğŸ“Š ${commitTitle} - ${timeStr}`;
            } else if (context.eventName === 'workflow_dispatch') {
              if (commitId) {
                // commit_idê°€ ìˆìœ¼ë©´ ì»¤ë°‹ ì •ë³´ í¬í•¨ (ì§§ì€ SHA ì‚¬ìš©)
                try {
                  const fullCommitId = execSync(`git rev-parse ${commitId}`, { encoding: 'utf8' }).trim();
                  const shortCommitId = fullCommitId.substring(0, 7);
                  issueTitle = `ğŸ“Š ${commitTitle} (${shortCommitId}) - ${timeStr}`;
                } catch (e) {
                  // ë³€í™˜ ì‹¤íŒ¨ ì‹œ ì›ë³¸ ì‚¬ìš©
                  const shortCommitId = commitId.substring(0, 7);
                  issueTitle = `ğŸ“Š ${commitTitle} (${shortCommitId}) - ${timeStr}`;
                }
              } else if (commitTitle !== 'Manual workflow run') {
                issueTitle = `ğŸ“Š ${commitTitle} - ${timeStr}`;
              } else {
                issueTitle = `ğŸ“Š ì›¹ì‚¬ì´íŠ¸ ì„±ëŠ¥ ì¸¡ì • ê²°ê³¼ - ${timeStr}`;
              }
            } else {
              issueTitle = `ğŸ“Š ì›¹ì‚¬ì´íŠ¸ ì„±ëŠ¥ ì¸¡ì • ê²°ê³¼ - ${timeStr}`;
            }

            console.log('Creating issue with title:', issueTitle);
            console.log('Repository:', context.repo.owner, context.repo.repo);

            try {
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: body,
                labels: ['lighthouse-audit', 'web-vitals']
              });
              console.log('âœ… Issue created successfully:', issue.data.html_url);
            } catch (error) {
              console.error('âŒ Failed to create issue:', error.message);
              console.error('Error details:', JSON.stringify(error, null, 2));
              throw error;
            }
