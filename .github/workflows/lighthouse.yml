name: Lighthouse CI

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      url:
        description: "URL to run Lighthouse on"
        required: false
        default: "http://localhost:8080"

permissions:
  issues: write
  contents: read

jobs:
  lighthouse-audit:
    name: Lighthouse Audit
    runs-on: ubuntu-latest
    # ì»¤ë°‹ ë©”ì‹œì§€ì— 'perf'ê°€ í¬í•¨ëœ ê²½ìš°ì—ë§Œ ì‹¤í–‰
    if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, 'perf')
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ì „ì²´ íˆìŠ¤í† ë¦¬ë¥¼ ê°€ì ¸ì™€ì„œ diffë¥¼ ìœ„í•´ í•„ìš”

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          npm install -g @lhci/cli@0.14.x
          npm install -g http-server

      - name: Start local server
        run: |
          http-server . -p 8080 &
          sleep 3
          curl -f http://localhost:8080 || exit 1

      - name: Run Lighthouse CI
        id: lighthouse
        continue-on-error: true
        run: |
          URL="${{ github.event.inputs.url || 'http://localhost:8080' }}"
          echo "Running Lighthouse CI on: $URL"

          # Lighthouse CI ì„¤ì • íŒŒì¼ ìƒì„± (ì—†ëŠ” ê²½ìš°)
          if [ ! -f "lighthouserc.js" ] && [ ! -f "lighthouserc.json" ]; then
            echo "Creating Lighthouse CI config..."
            cat > lighthouserc.json << EOF
          {
            "ci": {
              "collect": {
                "url": ["$URL"],
                "numberOfRuns": 1
              },
              "assert": {
                "assertions": {
                  "categories:performance": ["warn", {"minScore": 0}],
                  "categories:accessibility": ["warn", {"minScore": 0}],
                  "categories:best-practices": ["warn", {"minScore": 0}],
                  "categories:seo": ["warn", {"minScore": 0}]
                }
              },
              "upload": {
                "target": "filesystem",
                "outputDir": ".lighthouseci"
              }
            }
          }
          EOF
          fi

          # Lighthouse CI ì‹¤í–‰
          lhci autorun || {
            echo "Lighthouse CI failed, trying alternative method..."
            # ëŒ€ì•ˆ: ì§ì ‘ lighthouse ì‹¤í–‰
            npx @lhci/cli@0.14.x autorun || echo "All Lighthouse methods failed"
          }

          echo "Lighthouse CI execution completed"

      - name: Check Lighthouse reports
        if: always()
        run: |
          if [ -d ".lighthouseci" ]; then
            echo "Lighthouse reports directory exists"
            ls -la .lighthouseci/ || echo "Directory is empty"
          else
            echo "Lighthouse reports directory does not exist"
          fi

      - name: Get changed files diff
        id: get_diff
        if: always() && github.event_name == 'push'
        run: |
          if [ -n "${{ github.event.before }}" ] && [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            git diff ${{ github.event.before }}..${{ github.sha }} > /tmp/changes.diff || echo "No changes" > /tmp/changes.diff
          else
            echo "Initial commit or no previous commit" > /tmp/changes.diff
          fi

      - name: Create GitHub Issue with Results
        if: always()
        uses: actions/github-script@v6
        with:
          github-token: ${{ github.token }}
          script: |
            const fs = require('fs');
            const path = require('path');
            const { execSync } = require('child_process');

            // ì»¤ë°‹ ë©”ì‹œì§€ì—ì„œ ì œëª© ì¶”ì¶œ
            const commitMessage = context.eventName === 'push' 
              ? (context.payload.head_commit?.message || 'No commit message')
              : 'Manual workflow run';
            const commitTitle = commitMessage.split('\n')[0].trim();

            // ë³€ê²½ëœ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            let codeChanges = '';
            if (context.eventName === 'push') {
              try {
                const diffPath = '/tmp/changes.diff';
                if (fs.existsSync(diffPath)) {
                  const diffContent = fs.readFileSync(diffPath, 'utf8');
                  if (diffContent && !diffContent.includes('No changes') && !diffContent.includes('Initial commit')) {
                    // diffê°€ ë„ˆë¬´ ê¸¸ë©´ ì˜ë¼ë‚´ê¸° (GitHub IssueëŠ” 65,536ì ì œí•œ)
                    const maxLength = 50000;
                    let formattedDiff = diffContent;
                    if (diffContent.length > maxLength) {
                      formattedDiff = diffContent.substring(0, maxLength) + '\n\n... (truncated due to length)';
                    }
                    // diffë¥¼ ì½”ë“œ ë¸”ë¡ìœ¼ë¡œ í¬ë§·íŒ…
                    codeChanges = `\n### ğŸ“ ë³€ê²½ëœ ì½”ë“œ\n\n\`\`\`diff\n${formattedDiff}\n\`\`\`\n`;
                  }
                }
              } catch (e) {
                console.log('Could not read diff:', e.message);
              }
            }

            const lhciDir = '.lighthouseci';

            // Lighthouse ë¦¬í¬íŠ¸ ë””ë ‰í† ë¦¬ ë° íŒŒì¼ í™•ì¸
            console.log('Checking for Lighthouse reports...');
            console.log('Current working directory:', process.cwd());
            console.log('Lighthouse directory exists:', fs.existsSync(lhciDir));

            if (!fs.existsSync(lhciDir)) {
              console.log('âŒ Lighthouse ë¦¬í¬íŠ¸ ë””ë ‰í† ë¦¬ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
              console.log('Lighthouse CIê°€ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. Lighthouse CI ì‹¤í–‰ ë‹¨ê³„ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
              return;
            }

            const allFiles = fs.readdirSync(lhciDir);
            console.log('Files in .lighthouseci:', allFiles);

            const jsonReports = allFiles.filter(f => f.endsWith('.json'));
            console.log('JSON reports found:', jsonReports);

            if (jsonReports.length === 0) {
              console.log('âŒ Lighthouse ë¦¬í¬íŠ¸ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
              console.log('Lighthouse CIê°€ ì‹¤í–‰ë˜ì—ˆì§€ë§Œ ë¦¬í¬íŠ¸ íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
              return;
            }

            const latestReport = jsonReports.sort().reverse()[0];
            console.log('Latest report:', latestReport);

            if (!latestReport) {
              console.log('âŒ ìµœì‹  Lighthouse ë¦¬í¬íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              return;
            }

            const reportPath = path.join(lhciDir, latestReport);
            console.log('Reading report from:', reportPath);
            const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
            console.log('Report loaded successfully');

            const formatScore = (value = 0) => {
              return Math.round(value * 100);
            };

            const getEmoji = (value, metric) => {
              const thresholds = {
                LCP: { good: 2500, needsImprovement: 4000 },
                INP: { good: 200, needsImprovement: 500 },
                CLS: { good: 0.1, needsImprovement: 0.25 },
              };
              
              if (!thresholds[metric]) return value >= 90 ? 'ğŸŸ¢' : value >= 50 ? 'ğŸŸ ' : 'ğŸ”´';
              
              const t = thresholds[metric];
              return value <= t.good ? 'ğŸŸ¢' : value <= t.needsImprovement ? 'ğŸŸ ' : 'ğŸ”´';
            };

            const formatMetric = (value, metric) => {
              if (!value) return 'N/A';
              if (metric === 'CLS') return value.toFixed(3);
              return `${(value / 1000).toFixed(2)}s`;
            };

            const getLighthouseResult = (report, category) => {
              try {
                return report.categories?.[category]?.score ?? 0;
              } catch (e) {
                return 0;
              }
            };

            const getMetricValue = (report, metric) => {
              try {
                return report.audits?.[metric]?.numericValue ?? 0;
              } catch (e) {
                return 0;
              }
            };

            const lighthouseScores = {
              performance: getLighthouseResult(report, 'performance'),
              accessibility: getLighthouseResult(report, 'accessibility'),
              'best-practices': getLighthouseResult(report, 'best-practices'),
              seo: getLighthouseResult(report, 'seo'),
              pwa: getLighthouseResult(report, 'pwa')
            };

            const webVitals = {
              LCP: getMetricValue(report, 'largest-contentful-paint'),
              INP: getMetricValue(report, 'experimental-interaction-to-next-paint'),
              CLS: getMetricValue(report, 'cumulative-layout-shift')
            };

            const reportUrl = `.lighthouseci/${latestReport.replace('.json', '.html')}`;

            // ì‹œê°„ í¬ë§·íŒ…
            const now = new Date();
            const timeStr = now.toLocaleString('ko-KR', { 
              timeZone: 'Asia/Seoul',
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit',
              hour12: false
            });

            const body = `## ğŸš¨ ì›¹ì‚¬ì´íŠ¸ ì„±ëŠ¥ ì¸¡ì • ê²°ê³¼

            ${codeChanges}

            ### ğŸ¯ Lighthouse ì ìˆ˜
            | ì¹´í…Œê³ ë¦¬ | ì ìˆ˜ | ìƒíƒœ |
            |----------|------|------|
            | Performance | ${formatScore(lighthouseScores.performance)}% | ${getEmoji(formatScore(lighthouseScores.performance))} |
            | Accessibility | ${formatScore(lighthouseScores.accessibility)}% | ${getEmoji(formatScore(lighthouseScores.accessibility))} |
            | Best Practices | ${formatScore(lighthouseScores['best-practices'])}% | ${getEmoji(formatScore(lighthouseScores['best-practices']))} |
            | SEO | ${formatScore(lighthouseScores.seo)}% | ${getEmoji(formatScore(lighthouseScores.seo))} |
            | PWA | ${formatScore(lighthouseScores.pwa)}% | ${getEmoji(formatScore(lighthouseScores.pwa))} |

            ### ğŸ“Š Core Web Vitals (2024)
            | ë©”íŠ¸ë¦­ | ì„¤ëª… | ì¸¡ì •ê°’ | ìƒíƒœ |
            |--------|------|--------|------|
            | LCP | Largest Contentful Paint | ${formatMetric(webVitals.LCP, 'LCP')} | ${getEmoji(webVitals.LCP, 'LCP')} |
            | INP | Interaction to Next Paint | ${formatMetric(webVitals.INP, 'INP')} | ${getEmoji(webVitals.INP, 'INP')} |
            | CLS | Cumulative Layout Shift | ${formatMetric(webVitals.CLS, 'CLS')} | ${getEmoji(webVitals.CLS, 'CLS')} |

            ### ğŸ“ Core Web Vitals ê¸°ì¤€ê°’
            - **LCP (Largest Contentful Paint)**: ê°€ì¥ í° ì½˜í…ì¸ ê°€ í™”ë©´ì— ê·¸ë ¤ì§€ëŠ” ì‹œì  
              - ğŸŸ¢ Good: < 2.5s
              - ğŸŸ  Needs Improvement: < 4.0s
              - ğŸ”´ Poor: â‰¥ 4.0s

            - **INP (Interaction to Next Paint)**: ì‚¬ìš©ì ìƒí˜¸ì‘ìš©ì— ëŒ€í•œ ì „ë°˜ì ì¸ ì‘ë‹µì„±
              - ğŸŸ¢ Good: < 200ms
              - ğŸŸ  Needs Improvement: < 500ms
              - ğŸ”´ Poor: â‰¥ 500ms

            - **CLS (Cumulative Layout Shift)**: í˜ì´ì§€ ë¡œë“œ ì¤‘ ì˜ˆê¸°ì¹˜ ì•Šì€ ë ˆì´ì•„ì›ƒ ë³€ê²½ì˜ ì •ë„
              - ğŸŸ¢ Good: < 0.1
              - ğŸŸ  Needs Improvement: < 0.25
              - ğŸ”´ Poor: â‰¥ 0.25

            > ğŸ“… ì¸¡ì • ì‹œê°„: ${timeStr}`;

            // Issue ì œëª©: ì»¤ë°‹ ë©”ì‹œì§€ ì œëª© + ì‹œê°„
            const issueTitle = context.eventName === 'push'
              ? `ğŸ“Š ${commitTitle} - ${timeStr}`
              : `ğŸ“Š ì›¹ì‚¬ì´íŠ¸ ì„±ëŠ¥ ì¸¡ì • ê²°ê³¼ - ${timeStr}`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: body,
              labels: ['lighthouse-audit', 'web-vitals']
            });
